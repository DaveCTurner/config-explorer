<html>
<head>
<script src="https://d3js.org/d3.v4.js"></script>
<style>
body {
  font-family: sans-serif;
}

#steps {
  background-color: #f0f0f0;
  border: 1px solid black;
  padding: 10px;
}

.step {
  background-color: #e0e0e0;
  border: 1px solid black;
  padding: 10px;
  margin: 5px;
}

.zone {
  display: inline-block;
  background-color: #d0d0d0;
  border: 1px solid black;
  padding: 10px;
  margin: 5px;
}

.zoneName {
  margin: 0px;
  font-size: 50%;
}

.instance {
  display: inline-block;
  background-color: #ff8080;
  border: 1px solid black;
  padding: 10px;
  margin: 5px;
}

.instance.alive {
  background-color: #80e080;
}

.nodeId {
  font-size: 50%;
}

.weight {
  text-align: center;
  font-size: 150%;
}

</style>
</head>
<body><div id="steps"></div>
<button onclick="addAnotherStep()">Add another step</button>
<script>

function clone(x) { return JSON.parse(JSON.stringify(x)); }

var initialZone = {"instances":[]};
var initialStep = []
initialStep.push(clone(initialZone));
initialStep.push(clone(initialZone));
initialStep.push(clone(initialZone));
initialStep[0].zoneName = "eu-west-1a";
initialStep[1].zoneName = "eu-west-1b";
initialStep[2].zoneName = "eu-west-1c";
var steps = [initialStep];

var nextNodeId = 1;
function addNode(zone) {
  zone.instances.push({"nodeId": nextNodeId++, "weight": 0, "alive": true});
}

addNode(initialStep[0]);
addNode(initialStep[1]);
addNode(initialStep[2]);

function selectSteps() {
  return d3.select("#steps").selectAll(".step");
}

function selectZones() {
  return selectSteps().selectAll(".zone");
}

function selectInstances() {
  return selectZones().selectAll(".instance");
}

function refresh() {
  selectSteps().data(steps).enter().append("div").classed("step", true);
  selectZones().data(function(d) { return d; })
               .enter().append("div").classed("zone", true)
                       .append("p").classed("zoneName", true);
  selectZones().select(".zoneName").text(function(d) { return d.zoneName; });

  var instanceDivs    = selectInstances().data(function(d) { return d.instances; });
  var newInstanceDivs = instanceDivs.enter().append("div").classed("instance", true);

  newInstanceDivs.append("div").classed("nodeId", true);
  newInstanceDivs.append("div").classed("weight", true);
  newInstanceDivs.append("button").classed("nodeAction", true).on("click", function(d) { incWeight(d.nodeId); }).text('+');
  newInstanceDivs.append("button").classed("nodeAction", true).on("click", function(d) { decWeight(d.nodeId); }).text('-');
  newInstanceDivs.append("button").classed("nodeAction", true).on("click", function(d) { killNode(d.nodeId); }).text('x');

  var instanceDivs    = selectInstances().data(function(d) { return d.instances; });
  instanceDivs.classed("alive", function(d) { return d.alive; });
  instanceDivs.select(".nodeId").text(function(d) { return "n" + d.nodeId; });
  instanceDivs.select(".weight").text(function(d) { return d.weight; });
}

function onNodeById(step, nodeId, f) {
  step.forEach(function(zone) { zone.instances.forEach(function(instance) {
    if (instance.nodeId == nodeId) { f(instance); }}); });
}

function incWeight(nodeId) {
  var step = clone(steps[0]);
  onNodeById(step, nodeId, function(instance) { instance.weight++; });
  steps.unshift(step);
  refresh();
}

function decWeight(nodeId) {
  var step = clone(steps[0]);
  onNodeById(step, nodeId, function(instance) { if (instance.weight > 0) { instance.weight--; } });
  steps.unshift(step);
  refresh();
}

function killNode(nodeId) {
  var step = clone(steps[0]);
  onNodeById(step, nodeId, function(instance) { instance.alive = false; });
  steps.unshift(step);
  refresh();
}

refresh();

</script>
</body>
</html>
